<?xml version="1.0" encoding="iso-8859-1"?>
<project name="Jetrix TetriNET Server" default="dist" basedir=".">

  <property name="build.compiler" value="jikes"/>
  <property name="src"     value="src"/>
  <property name="lib"     value="lib"/>
  <property name="doc"     value="doc"/>
  <property name="build"   value="build"/>
  <property name="dist"    value="dist"/>
  <property name="deploy"  value="deploy"/>
  <property name="version" value="0.0.8"/>
  <property file="password.properties" />


  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build}"/>
  </target>


  <target name="compile" depends="init">
    <!-- Compile the java code from ${src} into ${build} -->
    <javac srcdir="${src}/java" destdir="${build}" debug="yes" />
  </target>


  <target name="compiletest" depends="compile" description="Compile JUnit TestCases">
    <javac srcdir="${src}/test" destdir="${build}" classpath="${build};${lib}/junit.jar;" debug="yes"/>     
  </target> 
  
  
  <target name="dist" depends="compile">
    <!-- Create the distribution directory -->
    <mkdir dir="${dist}/lib"/>
    <jar jarfile="${dist}/lib/jetrix.jar" basedir="${build}" manifest="${src}/etc/MANIFEST.MF" />    
    <zip zipfile="${dist}/bin/jetrix-${version}.zip">
      <zipfileset prefix="jetrix/" dir="${src}/etc/">
        <include name="news.txt" />
        <include name="LICENSE" />
        <include name="README" />
        <include name="config.xml" />
        <include name="jetrix.bat" />
        <include name="jetrix" />
        <include name="update.bat" />
        <include name="update" />        
      </zipfileset>
      <zipfileset prefix="jetrix/lib/" dir="${dist}/lib/">
        <include name="jetrix.jar" />    
      </zipfileset>
      <zipfileset prefix="jetrix/lib/" dir="${lib}/">
        <include name="crimson.jar" />      
      </zipfileset>      
    </zip>        
  </target>


  <target name="test" depends="compiletest" description="Runs testcases">    
    <junit printsummary="yes" fork="yes" dir="${src}/etc">
      <classpath> 
        <pathelement location="${lib}/crimson.jar"/>
        <pathelement path="${build}" />
      </classpath>    
      <formatter type="xml" />
      <batchtest>
        <fileset dir="${build}">
          <include name="**/*Test.class" />
        </fileset>
      </batchtest>
    </junit>               
    <junitreport>
      <fileset dir=".">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="noframes"/>
    </junitreport>    
    <delete>
      <fileset dir="." includes="TEST*"/>
    </delete>    
  </target>
    
  
  <target name="run" depends="dist">
    <delete dir="${deploy}"/>
    <mkdir dir="${deploy}"/>
    <unzip src="${dist}/bin/jetrix-${version}.zip" dest="${deploy}" />
    <java dir="${deploy}/jetrix" jar="${deploy}/jetrix/lib/jetrix.jar" fork="yes">
      <classpath> 
        <pathelement location="${deploy}/jetrix/lib/crimson.jar"/>
      </classpath> 
    </java>
  </target>
  
  
  <target name="update" depends="dist">
    <!-- Installing -->
    <delete dir="${deploy}"/>
    <mkdir dir="${deploy}"/>
    <unzip src="${dist}/bin/jetrix-${version}.zip" dest="${deploy}" />
    
    <!-- Checksum computation -->
    <java classname="org.lfjr.jts.patcher.UpdateList" dir="${deploy}/jetrix" classpath="${deploy}/jetrix/lib/jetrix.jar" fork="yes" />  
    
    <!-- Uploading to patch server -->
    <ftp server="${ftp.host}" remotedir="/site/tetrinet/jetrix/autoupdate" userid="${ftp.login}" password="${ftp.pass}" depends="yes" verbose="yes">
      <fileset dir="${deploy}/jetrix"/>
    </ftp>
  </target>  


  <target name="doc">
    <mkdir dir="${doc}/api"/>
    <mkdir dir="${dist}/doc"/>
    <javadoc packagenames="org.lfjr.jts,org.lfjr.jts.config,org.lfjr.jts.patcher"
             sourcepath="${src}/java"
             classpath="${src}/java"
             destdir="${doc}/api"
             author="true"
             version="true"
             use="false"
             windowtitle="Javadoc JetriX"
             doctitle="JetriX"
             bottom="Copyright &#169; 2001 Emmanuel Bourg. All Rights Reserved.">
      <link href="http://java.sun.com/j2se/1.3/docs/api/"/>
      <!--<link href="http://java.sun.com/j2ee/tutorial/api/"/>-->
    </javadoc>    
    <zip zipfile="${dist}/doc/api.zip">
      <zipfileset dir="${doc}" includes="api/**"/>
    </zip>    
  </target>


  <target name="clean">
    <!-- Delete the ${build} directory tree -->
    <delete dir="${build}"/>
    <delete dir="${deploy}"/>
  </target>
  
</project>
